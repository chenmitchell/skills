#!/usr/bin/env python3
"""å‘¨æŠ¥ç”Ÿæˆæ¨¡å—ï¼šæ¯å‘¨æ—¥ 23:59 æ±‡æ€»"""

import json
import logging
from datetime import datetime, timedelta
from pathlib import Path

logger = logging.getLogger("heartbeat.weekly")

WORKSPACE = Path(__file__).parent.parent / "workspace"


def _load_state() -> dict:
    """åŠ è½½çŠ¶æ€æ–‡ä»¶"""
    state_path = WORKSPACE / "state.json"
    if not state_path.exists():
        return {}
    try:
        return json.loads(state_path.read_text(encoding="utf-8"))
    except (json.JSONDecodeError, Exception):
        return {}


def generate_weekly_report() -> dict:
    """
    ç”Ÿæˆå‘¨æŠ¥æ•°æ®

    è¿”å›:
        {
            "period": str,
            "health_trend": {"avg": float, "min": int, "max": int, "total_beats": int},
            "task_summary": {"completed": int, "blocked": int, "active": int},
            "highlights": [str],
            "concerns": [str],
        }
    """
    now = datetime.now()
    week_start = now - timedelta(days=7)

    report = {
        "period": f"{week_start.strftime('%m-%d')} ~ {now.strftime('%m-%d')}",
        "health_trend": {"avg": 0, "min": 0, "max": 0, "total_beats": 0},
        "task_summary": {"completed": 0, "blocked": 0, "active": 0},
        "highlights": [],
        "concerns": [],
    }

    # å¥åº·åº¦è¶‹åŠ¿
    state = _load_state()
    week_scores = []
    week_start_str = week_start.strftime("%Y-%m-%d")
    for h in state.get("health_history", []):
        t = h.get("time", "")
        if t >= week_start_str:
            week_scores.append(h["score"])

    if week_scores:
        report["health_trend"] = {
            "avg": round(sum(week_scores) / len(week_scores), 1),
            "min": min(week_scores),
            "max": max(week_scores),
            "total_beats": len(week_scores),
        }

        # è¶‹åŠ¿åˆ†æ
        mid = len(week_scores) // 2
        first_half_avg = sum(week_scores[:mid]) / max(1, mid)
        second_half_avg = sum(week_scores[mid:]) / max(1, len(week_scores) - mid)

        if second_half_avg > first_half_avg + 5:
            report["highlights"].append("å¥åº·åº¦å‘ˆä¸Šå‡è¶‹åŠ¿ ğŸ“ˆ")
        elif second_half_avg < first_half_avg - 5:
            report["concerns"].append("å¥åº·åº¦å‘ˆä¸‹é™è¶‹åŠ¿ ğŸ“‰")
        else:
            report["highlights"].append("å¥åº·åº¦ä¿æŒç¨³å®š ğŸ“Š")

    # ä»»åŠ¡ç»Ÿè®¡
    ongoing_path = WORKSPACE / "ongoing.json"
    if ongoing_path.exists():
        try:
            data = json.loads(ongoing_path.read_text(encoding="utf-8"))
            tasks = data if isinstance(data, list) else data.get("tasks", [])
            for task in tasks:
                st = task.get("status", "")
                if st == "DONE":
                    report["task_summary"]["completed"] += 1
                elif st == "BLOCK":
                    report["task_summary"]["blocked"] += 1
                    report["concerns"].append(f"ä»»åŠ¡é˜»å¡: {task.get('title', '?')}")
                elif st in ("WIP", "WAIT"):
                    report["task_summary"]["active"] += 1
        except (json.JSONDecodeError, Exception):
            pass

    # è¿ç»­ streak
    streak = state.get("streak", 0)
    if streak >= 20:
        report["highlights"].append(f"è¿ç»­å¥åº·å¿ƒè·³: {streak} æ¬¡ ğŸ”¥")
    elif streak >= 10:
        report["highlights"].append(f"è¿ç»­å¥åº·å¿ƒè·³: {streak} æ¬¡ âœ…")

    return report


def format_weekly_report(report: dict) -> str:
    """å°†å‘¨æŠ¥æ•°æ®æ ¼å¼åŒ–ä¸ºé‚®ä»¶æ–‡æœ¬"""
    lines = []
    lines.append(f"ğŸ“Š EVA å‘¨æŠ¥ | {report['period']}")
    lines.append("=" * 40)
    lines.append("")

    # å¥åº·åº¦è¶‹åŠ¿
    h = report["health_trend"]
    lines.append("## å¥åº·åº¦è¶‹åŠ¿")
    lines.append(f"  å¹³å‡åˆ†: {h['avg']}")
    lines.append(f"  åˆ†æ•°èŒƒå›´: {h['min']} - {h['max']}")
    lines.append(f"  å¿ƒè·³æ€»æ¬¡æ•°: {h['total_beats']}")
    lines.append("")

    # ä»»åŠ¡ç»Ÿè®¡
    t = report["task_summary"]
    lines.append("## ä»»åŠ¡ç»Ÿè®¡")
    lines.append(f"  å·²å®Œæˆ: {t['completed']}")
    lines.append(f"  è¿›è¡Œä¸­: {t['active']}")
    lines.append(f"  é˜»å¡ä¸­: {t['blocked']}")
    lines.append("")

    # äº®ç‚¹
    if report["highlights"]:
        lines.append("## äº®ç‚¹")
        for item in report["highlights"]:
            lines.append(f"  âœ¨ {item}")
        lines.append("")

    # å…³æ³¨ç‚¹
    if report["concerns"]:
        lines.append("## éœ€å…³æ³¨")
        for item in report["concerns"]:
            lines.append(f"  âš ï¸ {item}")
        lines.append("")

    lines.append("---")
    lines.append("Generated by EVA Heartbeat Manager")

    return "\n".join(lines)


def send_weekly_report() -> bool:
    """ç”Ÿæˆå¹¶å‘é€å‘¨æŠ¥"""
    report = generate_weekly_report()
    body = format_weekly_report(report)

    from tools.mail import send_mail
    subject = f"[EVAå‘¨æŠ¥] {report['period']} | avg:{report['health_trend']['avg']}"

    sent = send_mail(subject, body)
    if sent:
        logger.info("å‘¨æŠ¥å‘é€æˆåŠŸ")
    else:
        logger.error("å‘¨æŠ¥å‘é€å¤±è´¥")
    return sent
